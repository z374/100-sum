Much better code here. 
First of all: it works.
Also, for example, this routine to generate base three number is nice

