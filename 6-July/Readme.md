The code here is really ugly. 
